<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>書籍分享平台｜首頁</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
  <style>
    body {
      margin: 0; padding: 0 20px;
    }

    header, nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 0;
      border-bottom: 1px solid #ccc;
    }

    .dropdown {
      position: relative;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: 36px;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      padding: 8px 0;
      z-index: 10;
    }

    .dropdown-menu a {
      display: block;
      padding: 6px 16px;
      text-decoration: none;
      color: black;
    }

    .dropdown-menu a:hover {
      background: #f2f2f2;
    }

    .section-title {
      margin-top: 30px;
    }

    .book-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
    }

    .book-card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: #fff;
      text-align: center;
    }

    .book-card img {
      max-width: 100%;
      height: 180px;
      object-fit: cover;
    }

    #silentBanner {
      display: none;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 12px;
      text-align: center;
      margin-bottom: 1rem;
    }

    #silentBanner a {
      color: #856404;
      text-decoration: underline;
    }
  </style>
</head>
<body>

<header>
  <h3>📚 書籍分享平台</h3>
  <nav>
    <a href="index.html">首頁</a>
    <a href="book_list.html">書籍總覽</a>
    <a href="my_shelf.html">我的書櫃</a>
    <a href="create_book_form.html">新增書籍</a>
    <a href="profile.html">會員中心</a>

    <div class="dropdown">
      <button onclick="toggleDropdown()">📖 分類 ▼</button>
      <div id="genreDropdown" class="dropdown-menu">
        <a href="book_list.html?category=奇幻">奇幻</a>
        <a href="book_list.html?category=愛情">愛情</a>
        <a href="book_list.html?category=校園">校園</a>
        <a href="book_list.html?category=科幻">科幻</a>
        <a href="book_list.html?category=推理">推理</a>
        <a href="book_list.html?category=歷史">歷史</a>
      </div>
    </div>
  </nav>
</header>

<!-- Silent Share Banner -->
<div id="silentBanner">
  <span id="silentMsg"></span>
  <button onclick="dismissBanner()">✖</button>
</div>

<!-- Recommended Section -->
<h4 class="section-title">推薦書籍</h4>
<div class="book-grid" id="recommendedBooks"></div>

<!-- Popular Section -->
<h4 class="section-title">熱門書籍</h4>
<div class="book-grid" id="popularBooks"></div>

<!-- Latest Section -->
<h4 class="section-title">最新上架</h4>
<div class="book-grid" id="latestBooks"></div>

<script>
  function toggleDropdown() {
    const menu = document.getElementById('genreDropdown');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  }

  window.addEventListener('click', function (e) {
    if (!e.target.closest('.dropdown')) {
      document.getElementById('genreDropdown').style.display = 'none';
    }
  });

  function dismissBanner() {
    document.getElementById('silentBanner').style.display = 'none';
  }

  async function checkSilentShare() {
    const res = await fetch('../backend/get_silent_share.php', { credentials: 'include' });
    const data = await res.json();
    if (data.success && data.book) {
      const banner = document.getElementById('silentBanner');
      const msg = document.getElementById('silentMsg');
      banner.style.display = 'block';
      msg.innerHTML = `「${data.sharer}」分享了一本書給你：<a href="book_detail.html?book_id=${data.book.book_id}&shared=true">${data.book.title}</a>`;
    }
  }

  async function loadBooks() {
    const res = await fetch('../backend/get_books_group.php');
    const books = await res.json();

    const recommended = books.filter(b => b.featured).slice(0, 4);
    const popular = [...books].sort((a, b) => b.views - a.views).slice(0, 4);
    const latest = [...books].sort((a, b) => new Date(b.create_time) - new Date(a.create_time)).slice(0, 4);

    renderBookList('recommendedBooks', recommended);
    renderBookList('popularBooks', popular);
    renderBookList('latestBooks', latest);
  }

  function renderBookList(containerId, bookList) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    bookList.forEach(book => {
      const card = document.createElement('div');
      card.className = 'book-card';
      card.innerHTML = `
        <img src="${book.cover_url || 'https://via.placeholder.com/150'}" alt="${book.title}">
        <h5>${book.title}</h5>
        <p>${book.author || '佚名'}</p>
        <a href="book_detail.html?book_id=${book.book_id}">查看書籍</a>
      `;
      container.appendChild(card);
    });
  }

  window.onload = () => {
    checkSilentShare();
    loadBooks();
  };
</script>

</body>
</html>
